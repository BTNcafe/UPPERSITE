global.BOOT=BOOT=function(params){"use strict";require("./UPPERCASE.JS-COMMON.js"),require("./UPPERCASE.JS-NODE.js"),CPU_CLUSTERING(function(workerData,on,broadcast){var cluster=require("cluster"),version=Date.now(),cpuCount=require("os").cpus().length,i,work=function(sharedData){var fs=require("fs"),path=require("path"),MULTI_LANG_SUPPORT=params.MULTI_LANG_SUPPORT,rootPath=__dirname+"/..",browserScript="\nglobal = window;\n",logoText,stringifyJSONWithFunction,loadAll,startServer,startREPL;stringifyJSONWithFunction=function(data){return JSON.stringify(data,function(t,e){return"function"==typeof e?"__THIS_IS_FUNCTION_START__"+e.toString()+"__THIS_IS_FUNCTION_END__":e},"	").replace(/("__THIS_IS_FUNCTION_START__(.*)__THIS_IS_FUNCTION_END__")/g,function(match,content){return eval("("+eval('"'+content.substring('"__THIS_IS_FUNCTION_START__'.length,content.length-'__THIS_IS_FUNCTION_END__"'.length)+'"')+")").toString()})},loadAll=function(t){var e,o,n,r,i,a,s,c,d,O,E,l,f;e=function(t){var e=t.path,o=t.name;return fs.statSync(rootPath+"/"+e).isDirectory()===!0&&"."!==o[0]&&"node_modules"!==o&&"not_load"!==o&&"deprecated"!==o&&"_"!==o[0]},o=function(){fs.readdirSync(rootPath).forEach(function(t){e({path:t,name:t})===!0&&(BOX(t),browserScript+="BOX('"+t+"');\n")})},n=function(t){var e,o,n,r=rootPath+"/"+t,i=path.extname(t);if(r.substring(0,(rootPath+"/UPPERSITE").length)!==rootPath+"/UPPERSITE")for(e in MULTI_LANG_SUPPORT)if(MULTI_LANG_SUPPORT.hasOwnProperty(e)===!0&&i==="."+e)return o="//"+fs.statSync(r).mtime.getTime(),(fs.existsSync(r+".__UPPERSITE_COMPILED")===!1||fs.readFileSync(r+".__UPPERSITE_COMPILED").toString().substring(0,o.length)!==o)&&(n=o+"\n"+MULTI_LANG_SUPPORT[e](fs.readFileSync(r).toString(),r),fs.writeFileSync(r+".__UPPERSITE_COMPILED",n)),void require(r+".__UPPERSITE_COMPILED");".js"===i||".JS"===i?require(r):".__UPPERSITE_COMPILED"===i&&fs.existsSync(r.substring(0,r.length-".__UPPERSITE_COMPILED".length))===!1&&fs.unlinkSync(r)},r=function(t){var e,o,n,r=rootPath+"/"+t,i=path.extname(t);if(r.substring(0,(rootPath+"/UPPERSITE").length)!==rootPath+"/UPPERSITE")for(e in MULTI_LANG_SUPPORT)if(MULTI_LANG_SUPPORT.hasOwnProperty(e)===!0&&i==="."+e)return o="//"+fs.statSync(r).mtime.getTime(),fs.existsSync(r+".__UPPERSITE_COMPILED")===!1||fs.readFileSync(r+".__UPPERSITE_COMPILED").toString().substring(0,o.length)!==o?(n=o+"\n"+MULTI_LANG_SUPPORT[e](fs.readFileSync(r).toString(),r),fs.writeFileSync(r+".__UPPERSITE_COMPILED",n)):n=fs.readFileSync(r+".__UPPERSITE_COMPILED").toString(),void(browserScript+=n+"\n");".js"===i||".JS"===i?(n=fs.readFileSync(r).toString(),browserScript+=n+"\n"):".__UPPERSITE_COMPILED"===i&&fs.existsSync(r.substring(0,r.length-".__UPPERSITE_COMPILED".length))===!1&&fs.unlinkSync(r)},i=function(t){n(t),r(t)},a=function(t,o){var n=function(t){var r,i;if(fs.existsSync(t)===!0)for(r=[],fs.readdirSync(t).forEach(function(n){var i=t+"/"+n;e({path:i,name:n})===!0?r.push(i):fs.statSync(rootPath+"/"+i).isDirectory()!==!0&&o(i)}),i=0;i<r.length;i+=1)n(r[i])};FOR_BOX(function(e){n(e.boxName+"/"+t)})},s=function(t){a(t,n)},c=function(t){a(t,r)},d=function(t){a(t,i)},O=function(){void 0!==params&&(void 0!==params.CONFIG&&(EXTEND_DATA({origin:global.CONFIG,extend:params.CONFIG}),browserScript+="EXTEND_DATA({ origin : global.CONFIG, extend : "+stringifyJSONWithFunction(params.CONFIG)+" });\n"),void 0!==params.NODE_CONFIG&&(EXTEND_DATA({origin:global.NODE_CONFIG,extend:params.NODE_CONFIG}),NODE_CONFIG.rootPath=rootPath),void 0!==params.BROWSER_CONFIG&&(browserScript+="EXTEND_DATA({ origin : global.BROWSER_CONFIG, extend : "+stringifyJSONWithFunction(params.BROWSER_CONFIG)+" });\n")),CONFIG.version=sharedData.version,CONFIG.workerId=cluster.worker.id,browserScript+="CONFIG.version = "+CONFIG.version+";\n",browserScript+="CONFIG.workerId = "+CONFIG.workerId+";\n"},E=function(t){NODE_CONFIG.isNotUsingDB===!0?t():(NODE_CONFIG.maxDataCount=NODE_CONFIG.maxDataCount,NODE_CONFIG.isNotRequiringDBAuth!==!0?CONNECT_TO_DB_SERVER({name:NODE_CONFIG.dbName,host:NODE_CONFIG.dbHost,port:NODE_CONFIG.dbPort,username:NODE_CONFIG.dbUsername,password:NODE_CONFIG.dbPassword},t):CONNECT_TO_DB_SERVER({name:NODE_CONFIG.dbName},t))},l=function(){var t=UPPERSITE.MODULE("uglify-js");browserScript=t.minify(browserScript,{fromString:!0,mangle:!0}).code},f=function(){logoText=fs.readFileSync(rootPath+"/UPPERSITE/LOGO"),browserScript="/* Welcome to JavaScript World! :)\n"+logoText+"\n  Contact: "+CONFIG.contactAddress+"\n\n*/"+browserScript},i("UPPERSITE/UPPERCASE.JS-COMMON.js"),i("UPPERSITE/OCTOPUS/UPPERCASE.IO-BOX/CORE.js"),o(),r("UPPERSITE/UPPERCASE.JS-BROWSER.js"),n("UPPERSITE/UPPERCASE.JS-NODE.js"),r("UPPERSITE/OCTOPUS/UPPERCASE.IO-BOX/BROWSER.js"),n("UPPERSITE/OCTOPUS/UPPERCASE.IO-DB/NODE.js"),n("UPPERSITE/OCTOPUS/UPPERCASE.IO-TRANSPORT/NODE.js"),d("COMMON"),s("SERVER"),c("BROWSER"),O(),r("UPPERSITE/BROWSER_INIT.js"),CONFIG.isDevMode!==!0&&l(),f(),E(t)},startServer=function(){var t,e,o,n,r=require("http"),i=require("https"),a=UPPERSITE.MODULE("socket.io"),s=UPPERSITE.MODULE("formidable").IncomingForm,c=UPPERSITE.MODULE("imagemagick");n=function(t,e){var o,n,r,i,a,d,O,E,l,f,I,P,u,S,N,_,C=t.url,T={},p=t.method.toUpperCase(),g=t.headers;g.ip=t.headers["X-Forwarded-For"],void 0===g.ip&&(g.ip=t.connection.remoteAddress),i=function(t){var e=path.extname(t);return".png"===e?"image/png":".jpg"===e||".jpeg"===e?"image/jpeg":".gif"===e?"image/gif":".js"===e?"text/javascript":".json"===e?"application/json":".css"===e?"text/css":".txt"===e?"text/plain":".html"===e?"text/html":".swf"===e?"application/x-shockwave-flash":"application/octet-stream"},a=function(t){return"text/javascript"===t?"utf-8":"text/css"===t?"utf-8":"text/plain"===t?"binary":"text/html"===t?"utf-8":"image/png"===t?"binary":"image/jpeg"===t?"binary":"image/gif"===t?"binary":"application/x-shockwave-flash"===t?"binary":"binary"},d=function(){var t=C.indexOf("?");-1!==t&&(n=decodeURI(C.substring(t+1)),C=C.substring(0,t)),o=C.substring(1)},O=function(){var t=o.indexOf("/");-1===t?r=CONFIG.defaultBoxName:(r=o.substring(0,t),void 0!==global[r]&&global[r].type===BOX?o=o.substring(t+1):r=CONFIG.defaultBoxName)},E=function(e){return e===!0?void 0!==t.headers["if-none-match"]||void 0!==t.headers["if-modified-since"]:void 0!==t.headers["if-none-match"]&&parseInt(t.headers["if-none-match"],10)===CONFIG.version||void 0!==t.headers["if-modified-since"]&&new Date(t.headers["if-modified-since"]).getTime()===1e3*parseInt(CONFIG.version/1e3,10)},l=function(t){e.writeHead(302,{Location:t}),e.end()},f=function(){e.statusCode=304,e.end()},I=function(t){var o=t.content,n=t.contentType,r=t.encoding,i=t.isToCache,a=t.lastModifiedTime;e.setHeader("Content-Type",n),CONFIG.isDevMode!==!0&&(void 0!==a?(e.setHeader("ETag",a.getTime()),e.setHeader("Last-Modified",a.toUTCString())):i===!0&&(e.setHeader("ETag",CONFIG.version),e.setHeader("Last-Modified",new Date(CONFIG.version).toUTCString()))),e.statusCode=200,e.end(o,r)},P=function(){I({content:browserScript,contentType:"text/javascript",encoding:"utf-8"})},u=function(){var o=new s,n=[],i={};o.uploadDir="__UPLOAD/"+r+"/__TEMP/",fs.existsSync(rootPath+"/"+o.uploadDir)===!1&&console.log("Not exists folder: "+rootPath+"/"+o.uploadDir),void 0!==global[r]&&fs.existsSync(rootPath+"/"+o.uploadDir)===!0?(o.on("field",function(t,e){i[t]=e}).on("file",function(t,e){n.push({tempPath:e.path,size:e.size,name:e.name,type:e.type,lastModifiedDate:e.lastModifiedDate})}).on("end",function(){var t=global[r].DB("__UPLOAD_FILE"),o=0;EACH(n,function(a){var s=a.tempPath;return a.size>1024*CONFIG.maxUploadFileMB*1024?(e.writeHead(200,{"Content-Type":"text/html"}),e.end("<script>errorCode='SIZE'</script>","utf-8"),!1):(EACH(i,function(t,e){""!==t.trim()&&(a[e]=t)}),REMOVE({data:a,key:"tempPath"}),void c.readMetadata(s,function(i,d){var O=function(){t.create(a,function(t,i){var a=UPPERSITE.MODULE("mv"),c=rootPath+"/__UPLOAD/"+r+"/"+i.id;void 0===t&&a(s,c,function(){o+=1,o===n.length&&(EACH(n,function(t,e){n[e]=PACK_DATA(t)}),e.writeHead(200,{"Content-Type":"text/html"}),e.end("<script>fileDataSet="+JSON.stringify(n)+"</script>","utf-8")),console.log("File '"+c+"' ("+i.name+", "+i.size+" byte) uploaded.")})})};void 0!==d.exif?(a.exif=d.exif,c.convert([s,"-auto-orient",s],function(){O()})):O()}))})}).on("error",function(){e.writeHead(200,{"Content-Type":"text/html"}),e.end("<script>errorCode='ERROR'</script>","utf-8")}),o.parse(t)):(e.writeHead(200,{"Content-Type":"text/html"}),e.end("<script>errorCode='ERROR'</script>","utf-8"))},S=function(){var t,e,s=rootPath+"/"+r+"/WEB/"+o;return o.length>=7&&"CACHED/"===o.substring(0,7)&&E(!0)===!0?void f():void(o.length>=9&&"__UPLOAD/"===o.substring(0,9)?(o=o.substring(9),N()):E()===!0?f():"/"!==C&&n!==CONFIG.version+""?l(C+"?"+CONFIG.version):void 0!==T[s]?I(T[s]):(t=i(o),e=a(t),fs.exists(s,function(o){o===!0?fs.readFile(s,e,function(o,n){null!==o?fs.exists(s+"/index.html",function(t){t===!0?fs.readFile(s+"/index.html","utf-8",function(t,e){null!==t?_(t):I({content:e,contentType:"text/html",encoding:"utf-8"})}):_()}):I(T[s]={content:n,contentType:t,encoding:e,isToCache:"/"!==C})}):_()})))},N=function(){var t;E(!0)===!0?f():(t=rootPath+"/__UPLOAD/"+r+"/"+o,fs.exists(t,function(e){e===!0?fs.readFile(t,"binary",function(e,o){null!==e?_(e):fs.stat(t,function(t,e){null!==t?_(t):I({content:o,contentType:"application/octet-stream",encoding:"binary",lastModifiedTime:e.mtime})})}):_()}))},_=function(t){void 0!==t&&console.log("[UPPERSITE] ERROR:",t),fs.exists(CONFIG.defaultBoxName+"/ERROR.html",function(t){t===!0?fs.readFile(CONFIG.defaultBoxName+"/ERROR.html","utf-8",function(t,o){null===t&&(e.writeHead(500,{"Content-Type":"text/html"}),e.end(o,"utf-8"))}):fs.readFile("UPPERSITE/ERROR.html","utf-8",function(t,o){null===t&&(e.writeHead(500,{"Content-Type":"text/html"}),e.end(o,"utf-8"))})})},d(),"POST"===p?(O(),"__UPLOAD"===o?u():(n="",t.on("data",function(t){n+=t}),t.on("end",function(){void 0!==global[r]&&void 0!==global[r].REQUEST&&void 0!==global[r].REQUEST.checkURI&&global[r].REQUEST.checkURI({uri:o,method:p,paramStr:n,headers:g},{response:I,serveErrorPage:_})===!0||S(r)}))):"GET"===p?"__SCRIPT"===o?P():(O(),""===o&&(o="index.html"),void 0!==global[r]&&void 0!==global[r].REQUEST&&void 0!==global[r].REQUEST.checkURI&&global[r].REQUEST.checkURI({uri:o,method:p,paramStr:n,headers:g},{response:I,serveErrorPage:_})===!0||S(r)):("PUT"===p||"DELETE"===p)&&(O(),void 0!==global[r]&&void 0!==global[r].REQUEST&&void 0!==global[r].REQUEST.checkURI&&global[r].REQUEST.checkURI({uri:o,method:p,paramStr:n,headers:g},{response:I,serveErrorPage:_})===!0||S(r))},t=r.createServer(n).listen(CONFIG.port),void 0!==NODE_CONFIG.securedPort&&(e=i.createServer({key:fs.readFileSync(rootPath+"/"+NODE_CONFIG.securedKeyFileName),cert:fs.readFileSync(rootPath+"/"+NODE_CONFIG.securedCrtFileName)},n).listen(NODE_CONFIG.securedPort)),o=a.listen(void 0===CONFIG.socketIOPorts||void 0===CONFIG.socketIOPorts[CONFIG.workerId]?CONFIG.port+CONFIG.workerId:CONFIG.socketIOPorts[CONFIG.workerId]),console.log("Socket.IO port:",void 0===CONFIG.socketIOPorts||void 0===CONFIG.socketIOPorts[CONFIG.workerId]?CONFIG.port+CONFIG.workerId:CONFIG.socketIOPorts[CONFIG.workerId]),CONFIG.isDevMode===!0?o.set("log level",2):o.set("log level",1),o.configure(function(){o.set("flash policy port",void 0===CONFIG.flashPolicyServerPort?CONFIG.port+1955:CONFIG.flashPolicyServerPort),o.set("transports",CONFIG.transports)}),CONNS.socketPack=o.sockets,CONNS.broadcastToAllWorkers=broadcast,INIT_OBJECTS(),on("emitToAllSockets",function(t){CONNS.emitToAllSockets(t)}),FOR_BOX(function(t){void 0!==t.MAIN&&t.MAIN(workerData,{on:on,broadcast:broadcast})}),console.log("[UPPERSITE] "+CONFIG.defaultTitle+" WORKER #"+workerData.id+" (PID:"+workerData.pid+") BOOTed. => http://localhost:"+CONFIG.port+(void 0!==NODE_CONFIG.securedPort?" SECUREd => https://localhost:"+NODE_CONFIG.securedPort:""))},startREPL=function(){DELAY(1,function(){var t=require("repl");t.start({prompt:"UPPERSITE> ",input:process.stdin,output:process.stdout})})},loadAll(function(){startServer(),NODE_CONFIG.isUsingREPL===!0&&startREPL()})},fork=function(){cluster.fork().send({version:version})};work({version:version})})};