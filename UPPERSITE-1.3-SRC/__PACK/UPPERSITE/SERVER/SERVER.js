global.CONNS=CONNS=OBJECT(function(){"use strict";return{init:function(e,o){var r,t,a,n=o.socketPack,i=[];o.addDisconnectListener=r=function(e){i.push(e)},n.on("connection",function(e){var o={};e.addListener("disconnect",function(){EACH(i,function(o){o(e.id)})}),e.emit("__CONNECTED",e.id),e.addListener("__ENTER_ROOM",function(r){void 0===o[r]?(e.join(r),o[r]=1):o[r]+=1}),e.addListener("__EXIT_ROOM",function(r){o[r]-=1,0===o[r]&&(e.leave(r),delete o[r])})}),o.emitToAllSockets=t=function(e){var o=e.fullURI,r=e.listenerName,t=e.data;CONNS.socketPack["in"](o).emit(r,t)},o.emitToAllWorkers=a=function(e){t(e),o.broadcastToAllWorkers({methodName:"emitToAllSockets",data:e})}}}}),FOR_BOX(function(e){"use strict";OVERRIDE(e.MODEL,function(){e.MODEL=CLASS({init:function(o,r,t){var a,n,i,d,c,s,v,u,f,m,E,O,R,h,C,N,p,b,S,g,M,D,_,l=t.name,A=t.config,T=e.DB(l),k=e.ROOM(l),U=e.ROOM(l+"/{id}");void 0!==A&&(a=A.create,n=A.get,i=A.update,d=A.remove,c=A.find,s=A.count,v=A.checkIsExists,void 0!==a&&(u=a.valid,m=a.initData),void 0!==i&&(f=i.valid)),o.getCreateValid=O=function(){return u},o.getUpdateValid=R=function(){return f},o.initData=E=function(e){return void 0!==m&&m(e),e},a!==!1&&k.on("create",function(r,t,a,n){var i,d;E(t),void 0!==u&&(i=u.check({data:t})),void 0!==i&&i.checkHasError()===!0?n({hasError:!0,errors:i.getErrors()}):(d=function(){T.create(t,function(r,t){void 0!==r?n({hasError:!0,errorMsg:r}):(void 0!==o.afterCreate&&o.afterCreate(t),void 0!==o.afterCreateRoom&&o.afterCreateRoom({room:k,savedData:t,headers:a}),e.ROOMS(l+"/create").broadcast({methodName:"create",data:t}),EACH(t,function(o,r){e.ROOMS(l+"/"+r+"/"+o+"/create").broadcast({methodName:"create",data:t})}),n({hasError:!1,savedData:t}))})},void 0===o.beforeCreateRoom?void 0!==o.beforeCreate?o.beforeCreate(t,{ret:n,proc:d})!==!1&&d():d():o.beforeCreateRoom({room:k,data:t,headers:a},{ret:n,proc:d}))}),i!==!1&&U.on("update",function(r,t,a,n){var i,d=r.id,c=void 0===f?void 0:f.check({data:t,isExceptUndefined:!0});t.id=d,void 0!==f&&c.checkHasError()===!0?n({hasError:!0,errors:c.getErrors()}):(i=function(){T.update(t,function(r,t){void 0!==r?n({hasError:!0,errorMsg:r}):(void 0!==t&&(void 0!==o.afterUpdate&&o.afterUpdate(t),void 0!==o.afterUpdateRoom&&o.afterUpdateRoom({room:U,savedData:t,headers:a}),e.ROOMS(l+"/"+d).broadcast({methodName:"update",data:t}),EACH(t,function(o,r){e.ROOMS(l+"/"+r+"/"+o+"/update").broadcast({methodName:"update",data:t})})),n({hasError:!1,savedData:t}))})},void 0===o.beforeUpdateRoom?void 0!==o.beforeUpdate?o.beforeUpdate(t,{ret:n,proc:i})!==!1&&i():i():o.beforeUpdateRoom({room:U,data:t,headers:a},{ret:n,proc:i})!==!1&&i())}),d!==!1&&U.on("remove",function(r,t,a,n){var i;i=function(){T.remove(t,function(r,i){void 0!==r?n({hasError:!0,errorMsg:r}):(void 0!==i&&(void 0!==o.afterRemove&&o.afterRemove(i),void 0!==o.afterRemoveRoom&&o.afterRemoveRoom({room:U,savedData:i,headers:a}),e.ROOMS(l+"/"+t).broadcast({methodName:"remove",data:i}),EACH(i,function(o,r){e.ROOMS(l+"/"+r+"/"+o+"/remove").broadcast({methodName:"remove",data:i})})),n({hasError:!1,savedData:i}))})},void 0===o.beforeRemoveRoom?void 0!==o.beforeRemove?o.beforeRemove(t,{ret:n,proc:i})!==!1&&i():i():o.beforeRemoveRoom({room:roomForRemove,id:t,headers:a},{ret:n,proc:i})!==!1&&i()}),o.getDB=h=function(){return T},o.getRoom=C=function(){return k},a!==!1&&(r.create=N=function(r,t){var a,n;E(r),void 0!==u&&(a=u.check({data:r})),void 0!==a&&a.checkHasError()===!0?void 0!==t&&t({hasError:!0,errors:a.getErrors()}):(n=function(){T.create(r,function(r,a){void 0!==r?void 0!==t&&t({hasError:!0,errorMsg:r}):(void 0!==o.afterCreate&&o.afterCreate(a),e.ROOMS(l+"/create").broadcast({methodName:"create",data:a}),EACH(a,function(o,r){e.ROOMS(l+"/"+r+"/"+o+"/create").broadcast({methodName:"create",data:a})}),void 0!==t&&t({hasError:!1,savedData:a}))})},void 0!==o.beforeCreate?o.beforeCreate(r,{ret:t,proc:n})!==!1&&n():n())}),n!==!1&&(r.get=p=function(e,r){T.get(e,function(e,t){void 0!==e?void 0!==r&&r({hasError:!0,errorMsg:e}):(void 0===o.get||o.get(t,r)!==!1)&&void 0!==r&&r({hasError:!1,savedData:t})})}),i!==!1&&(r.update=b=function(r,t){var a,n=void 0===f?void 0:f.check({data:r,isExceptUndefined:!0});void 0!==n&&n.checkHasError()===!0?void 0!==t&&t({hasError:!0,errors:n.getErrors()}):(a=function(){T.update(r,function(a,n){void 0!==a?void 0!==t&&t({hasError:!0,errorMsg:a}):(void 0!==n&&(void 0!==o.afterUpdate&&o.afterUpdate(n),e.ROOMS(l+"/"+r.id).broadcast({methodName:"update",data:n}),EACH(n,function(o,r){e.ROOMS(l+"/"+r+"/"+o+"/update").broadcast({methodName:"update",data:n})})),void 0!==t&&t({hasError:!1,savedData:n}))})},void 0!==o.beforeUpdate?o.beforeUpdate(r,{ret:t,proc:a})!==!1&&a():a())}),d!==!1&&(r.remove=S=function(r,t){var a;a=function(){T.remove(r,function(r,a){void 0!==r?void 0!==t&&t({hasError:!0,errorMsg:r}):(void 0!==a&&(void 0!==o.afterRemove&&o.afterRemove(a),e.ROOMS(l+"/"+a.id).broadcast({methodName:"remove",data:a}),EACH(a,function(o,r){e.ROOMS(l+"/"+r+"/"+o+"/remove").broadcast({methodName:"remove",data:a})})),void 0!==t&&t({hasError:!1,savedData:a}))})},void 0!==o.beforeRemove?o.beforeRemove(r,{ret:t,proc:a})!==!1&&a():a()}),c!==!1&&(r.find=g=function(e,r){void 0!==e&&void 0===r&&(r=e,e=void 0),T.find(e,function(e,t){void 0!==e?void 0!==r&&r({hasError:!0,errorMsg:e}):(void 0===o.find||o.find(t,r)!==!1)&&void 0!==r&&r({hasError:!1,savedDataSet:t})})}),s!==!1&&(r.count=M=function(e,r){void 0!==e&&void 0===r&&(r=e,e=void 0),T.count(e,function(e,t){void 0!==e?void 0!==r&&r({hasError:!0,errorMsg:e}):(void 0===o.count||o.count(t,r)!==!1)&&void 0!==r&&r({hasError:!1,count:t})})}),v!==!1&&(r.checkIsExists=D=function(e,r){void 0!==e&&void 0===r&&(r=e,e=void 0),T.checkIsExists(e,function(e,t){void 0!==e?void 0!==r&&r({hasError:!0,errorMsg:e}):(void 0===o.checkIsExists||o.checkIsExists(t,r)!==!1)&&void 0!==r&&r({hasError:!1,isExists:t})})}),n!==!1&&k.on("get",function(e,o,r,t){p(o,t)}),c!==!1&&k.on("find",function(e,o,r,t){delete e.isFindAll,g(o,t)}),s!==!1&&k.on("count",function(e,o,r,t){M(o,t)}),v!==!1&&k.on("checkIsExists",function(e,o,r,t){D(o,t)}),o.getName=_=function(){return l}}})})}),FOR_BOX(function(e){"use strict";e.MODULE=METHOD({run:function(o){var r=__dirname+"/../..";return require(r+"/"+e.boxName+"/SERVER/node_modules/"+o)}})}),OVERRIDE(NODE_CONFIG,function(e){global.NODE_CONFIG=NODE_CONFIG=COMBINE_DATA({origin:e,extend:{dbName:"UPPERSITE-testdb",dbUsername:"test",dbPassword:"test",maxDataCount:1e3}})}),FOR_BOX(function(e){"use strict";e.REQUEST=METHOD(function(e){var o,r,t={};return e.getFuncs=o=function(){return t},e.checkURI=r=function(e,o){var r=e.uri,a=e.paramStr,n=(e.ip,e.headers),i=e.method,d=o.response,c=o.serveErrorPage;return EACH(t,function(e,o){var t,s="",v=o,u={};return t=function(e){var o,r;return-1!==v.indexOf("{")&&-1!==v.indexOf("}")&&(r=v.substring(0,v.indexOf("{")),s+"/"===r)?(o=v.substring(v.indexOf("{")+1,v.indexOf("}")),v=r+e+v.substring(v.indexOf("}")+1),{name:o,value:e}):void 0},EACH(r.split("/"),function(e,o){var r=t(e);return void 0!==r&&(u[r.name]=r.value),0===o?s=e:s+="/"+e,s===v?!1:void 0}),r===v?(e(i,u,a,n,d,c),!1):void 0})===!1},{run:function(e,o){t[e]=o}}})}),FOR_BOX(function(e){"use strict";e.REQUEST_JSON=METHOD({run:function(o,r){e.REQUEST.getFuncs()[o]=function(e,o,t,a,n,i){var d,c=require("querystring");try{d=UNPACK_DATA(JSON.parse(c.parse(t).data))}catch(s){return void i(s)}return r(e,o,d,a,n,i)}}})}),FOR_BOX(function(e){"use strict";e.ROOM=CLASS({init:function(o,r,t){var a,n;r.on=a=function(o,r){e.REQUEST_JSON("__FOR_ROOM/"+t+"/"+o,function(e,o,t,a,n){a.socketId=t.socketId,r(o,t.data,a,function(e){n({content:JSON.stringify(CHECK_IS_DATA(e)===!0?PACK_DATA(e):e),contentType:"application/json",encoding:"utf-8"})})})},r.addDisconnectListener=n=function(e){CONNS.addDisconnectListener(e)}}})}),FOR_BOX(function(e){"use strict";e.ROOMS=CLASS({init:function(o,r,t){var a,n=e.boxName+"/"+t;r.broadcast=a=function(e){var o=e.methodName,r=CHECK_IS_DATA(e.data)===!0?PACK_DATA(e.data):e.data,t=n+"/"+o;CONNS.emitToAllWorkers({ns:n,listenerName:t,data:r})}}})}),global.TIME_SYNC=TIME_SYNC=OBJECT({init:function(){"use strict";var e=UPPERSITE.ROOM("timeSync");e.on("sync",function(e,o,r,t){var a=new Date,n=o.now;t({diff:n-a})})}});